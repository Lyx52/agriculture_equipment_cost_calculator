const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/visualVariableUtils-pBcvJ6fg.js","assets/index-I9roUNmP.js","assets/index-BxiXB3DQ.css","assets/sizeVariableUtils-Cmcuvw-4.js"])))=>i.map(i=>d[i]);
import{k as T,v as d,w as g,x as H,ax as L,eX as O,bI as Q,s as P,V as U,F as G,ag as R,_ as M,aa as $,bP as z,fC as j,b2 as k,fD as q,bd as C,fE as D,E as S,fF as N,cd as W,cf as X,cA as B}from"./index-I9roUNmP.js";import{H as J}from"./languageUtils-dtj-D57g.js";import{o as A}from"./drapedUtils-MtdkTEYD.js";import{n as K,p as Y}from"./popupUtils-_bvZvSpw.js";const V=T();let b=null;function oe(t,s){return s.type==="tile"||s.type==="map-image"}let y=class extends L{constructor(t){super(t),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=O(async s=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(s).catch(()=>{}))})}initialize(){const t=s=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(s).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([Q(()=>this.highlightGraphics,"change",s=>t(s.added),{onListenerAdd:s=>t(s)})])}async fetchPopupFeaturesAtLocation(t,s){var i,u;const{layerView:{layer:e,view:{scale:a}}}=this;if(!t)throw new P("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:e});const r=Z(e.sublayers,a,s);if(!r.length)return[];const n=await te(e,r);if(!((((u=(i=e.capabilities)==null?void 0:i.operations)==null?void 0:u.supportsIdentify)??!0)&&e.version>=10.5)&&!n)throw new P("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:e});return n?this._fetchPopupFeaturesUsingQueries(t,r,s):this._fetchPopupFeaturesUsingIdentify(t,r,s)}clearHighlights(){var t;(t=this.highlightGraphics)==null||t.removeAll()}highlight(t){const s=this.highlightGraphics;if(!t||!s)return V;let e=J(t)?[t]:U.isCollection(t)?t.toArray():Array.isArray(t)?t:[];if(e=e==null?void 0:e.filter(G),((e==null?void 0:e.length)??0)===0)return V;for(const a of e){const{sourceLayer:r}=a;r!=null&&"geometryType"in r&&r.geometryType==="point"&&(a.visible=!1)}return s.addMany(e),T(()=>s.removeMany(e??[]))}async _updateHighlightedFeaturesSymbols(t){const{layerView:{view:s},highlightGraphics:e,highlightGraphicUpdated:a}=this;if(e&&a)for(const r of t){const n=r.sourceLayer&&"renderer"in r.sourceLayer&&r.sourceLayer.renderer;r.sourceLayer&&"geometryType"in r.sourceLayer&&r.sourceLayer.geometryType==="point"&&n&&"getSymbolAsync"in n&&n.getSymbolAsync(r).then(async i=>{var o;i||(i=new R);let u=null;const p="visualVariables"in n?(o=n.visualVariables)==null?void 0:o.find(l=>l.type==="size"):void 0;p&&(b||(b=(await M(async()=>{const{getSize:l}=await import("./visualVariableUtils-pBcvJ6fg.js");return{getSize:l}},__vite__mapDeps([0,1,2,3]))).getSize),u=b(p,r,{view:s.type,scale:s.scale,shape:i.type==="simple-marker"?i.style:null})),u||(u="width"in i&&"height"in i&&i.width!=null&&i.height!=null?Math.max(i.width,i.height):"size"in i?i.size:16),e.includes(r)&&(r.symbol=new R({style:"square",size:u,xoffset:"xoffset"in i?i.xoffset:0,yoffset:"yoffset"in i?i.yoffset:0}),a(r,"symbol"),r.visible=!0)})}}async _updateHighlightedFeaturesGeometries(t){const{layerView:{layer:s,view:e},highlightGraphics:a,highlightGraphicUpdated:r}=this;if(this._highlightGeometriesResolution=t,!r||!(a!=null&&a.length)||!s.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(t),i=new Map;for(const o of a)if(!this._featuresResolutions.has(o)||this._featuresResolutions.get(o)>n){const l=o.sourceLayer;$(i,l,()=>new Map).set(o.getObjectId(),o)}const u=Array.from(i,([o,l])=>{const c=o.createQuery();return c.objectIds=[...l.keys()],c.outFields=[o.objectIdField],c.returnGeometry=!0,c.maxAllowableOffset=n,c.outSpatialReference=e.spatialReference,o.queryFeatures(c)}),p=await Promise.all(u);if(!this.destroyed)for(const{features:o}of p)for(const l of o){const c=l.sourceLayer,h=i.get(c).get(l.getObjectId());h&&a.includes(h)&&(h.geometry=l.geometry,r(h,"geometry"),this._featuresResolutions.set(h,n))}}_getTargetResolution(t){const s=t*z(this.layerView.view.spatialReference),e=s/16;return e<=10?0:t/s*e}async _fetchPopupFeaturesUsingIdentify(t,s,e){const a=await this._createIdentifyParameters(t,s,e);if(a==null)return[];const{results:r}=await j(this.layerView.layer.parsedUrl,a,e);return r.map(n=>n.feature)}async _createIdentifyParameters(t,s,e){const{floors:a,layer:r,timeExtent:n,view:{spatialReference:i,scale:u}}=this.layerView;if(!s.length)return null;await Promise.all(s.map(({sublayer:f})=>f.load(e).catch(()=>{})));const p=Math.min(k("mapservice-popup-identify-max-tolerance"),r.allSublayers.reduce((f,m)=>m.renderer?A({renderer:m.renderer,pointerType:e==null?void 0:e.pointerType}):f,2)),o=this.createFetchPopupFeaturesQueryGeometry(t,p),l=q(u,i),c=Math.round(o.width/l),h=new C({xmin:o.center.x-l*c,ymin:o.center.y-l*c,xmax:o.center.x+l*c,ymax:o.center.y+l*c,spatialReference:o.spatialReference});return new D({floors:a,gdbVersion:"gdbVersion"in r?r.gdbVersion:void 0,geometry:t,height:c,layerOption:"popup",mapExtent:h,returnGeometry:!0,spatialReference:i,sublayers:r.sublayers,timeExtent:n,tolerance:p,width:c})}async _fetchPopupFeaturesUsingQueries(t,s,e){const{layerView:{floors:a,timeExtent:r}}=this,n=s.map(async({sublayer:i,popupTemplate:u})=>{var F;if(await i.load(e).catch(()=>{}),i.capabilities&&!i.capabilities.operations.supportsQuery)return[];const p=i.createQuery(),o=A({renderer:i.renderer,pointerType:e==null?void 0:e.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(t,o),c=new Set,[h]=await Promise.all([K(i,u),(F=i.renderer)==null?void 0:F.collectRequiredFields(c,i.fieldsIndex)]);S(e),N(c,i.fieldsIndex,h);const f=Array.from(c).sort();p.geometry=l,p.outFields=f,p.timeExtent=r;const m=W(a,i);p.where=X(p.where,m);const v=this._getTargetResolution(l.width/o),x=await ee(u);S(e);const _=i.geometryType==="point"||x&&x.arcadeUtils.hasGeometryOperations(u);_||(p.maxAllowableOffset=v);let{features:w}=await i.queryFeatures(p,e);const I=_?0:v;w=await se(i,w,e);for(const E of w)this._featuresResolutions.set(E,I);return w});return(await Promise.allSettled(n)).reduce((i,u)=>u.status==="fulfilled"?[...i,...u.value]:i,[]).filter(G)}};function Z(t,s,e){const a=[];if(!t)return a;const r=n=>{const i=n.minScale===0||s<=n.minScale,u=n.maxScale===0||s>=n.maxScale;if(n.visible&&i&&u){if(n.sublayers)n.sublayers.forEach(r);else if(n.popupEnabled){const p=Y(n,{...e,defaultPopupTemplateEnabled:!1});p!=null&&a.unshift({sublayer:n,popupTemplate:p})}}};return t.map(r),a}function ee(t){var s;return(s=t.expressionInfos)!=null&&s.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?B():Promise.resolve()}async function te(t,s){var e,a;if((a=(e=t.capabilities)==null?void 0:e.operations)!=null&&a.supportsQuery)return!0;try{return await Promise.any(s.map(({sublayer:r})=>r.load().then(()=>r.capabilities.operations.supportsQuery)))}catch{return!1}}async function se(t,s,e){const a=t.renderer;return a&&"defaultSymbol"in a&&!a.defaultSymbol&&(s=a.valueExpression?await Promise.all(s.map(r=>a.getSymbolAsync(r,e).then(n=>n?r:null))).then(r=>r.filter(n=>n!=null)):s.filter(r=>a.getSymbol(r)!=null)),s}d([g({constructOnly:!0})],y.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),d([g({constructOnly:!0})],y.prototype,"layerView",void 0),d([g({constructOnly:!0})],y.prototype,"highlightGraphics",void 0),d([g({constructOnly:!0})],y.prototype,"highlightGraphicUpdated",void 0),d([g({constructOnly:!0})],y.prototype,"updatingHandles",void 0),y=d([H("esri.views.layers.support.MapServiceLayerViewHelper")],y);export{y as R,oe as _};
